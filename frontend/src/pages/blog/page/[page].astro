---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import BlogListing from "../../../components/blog/BlogListing";
import {
  getAllBlogPosts,
  getAllBlogCategories,
} from "../../../services/blogService";
import { POSTS_PER_PAGE } from "../../../config/blog";
import type { BlogPost, BlogCategory } from "../../../sanity/types/blog";

interface CategoryUI {
  slug: string;
  title: string;
}

interface PageProps {
  page: number;
  totalPages: number;
  totalPostsInScope: number;
  pagePosts: BlogPost[];
  allScopePosts: BlogPost[];
  categories: CategoryUI[];
  featuredPost?: BlogPost;
}

export async function getStaticPaths() {
  const [allPosts, allCategories]: [BlogPost[], BlogCategory[]] =
    await Promise.all([getAllBlogPosts(), getAllBlogCategories()]);

  const featuredPost = allPosts.find((p) => p.featured);
  const regularPosts = allPosts.filter((p) => !p.featured);

  const totalPostsInScope = regularPosts.length;
  const totalPages = Math.ceil(totalPostsInScope / POSTS_PER_PAGE);

  const categories: CategoryUI[] = allCategories.map((cat) => ({
    slug: cat.slug,
    title: cat.title,
  }));

  const paths: { params: { page: string }; props: PageProps }[] = [];

  for (let page = 2; page <= totalPages; page++) {
    const startIndex = (page - 1) * POSTS_PER_PAGE;
    const pagePosts = regularPosts.slice(
      startIndex,
      startIndex + POSTS_PER_PAGE
    );

    paths.push({
      params: { page: String(page) },
      props: {
        page,
        totalPages,
        totalPostsInScope,
        pagePosts,
        allScopePosts: regularPosts,
        categories,
        featuredPost,
      },
    });
  }

  return paths;
}

const {
  page,
  totalPages,
  totalPostsInScope,
  pagePosts,
  allScopePosts,
  categories,
  featuredPost,
} = Astro.props as PageProps;
---

<BaseLayout
  title={`Blog - Página ${page} | DiSa Consultoría`}
  description={`Explora nuestros artículos - Página ${page}`}
  canonicalURL={new URL(`/blog/page/${page}`, Astro.site)}
  noindex={true}
>
  <BlogListing
    client:load
    scope="all"
    page={page}
    totalPages={totalPages}
    totalPostsInScope={totalPostsInScope}
    pagePosts={pagePosts}
    allScopePosts={allScopePosts}
    categories={categories}
    featuredPost={featuredPost}
    basePath="/blog"
  />
</BaseLayout>
