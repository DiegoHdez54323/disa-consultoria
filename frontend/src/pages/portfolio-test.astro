---
import type { PortfolioProject } from "../sanity/types/portfolio";
import {
  getAllPortfolioProjects,
  getPortfolioProjectsByCategorySlug,
  getPortfolioProjectById,
} from "../services/portfolioService";
import { urlForImage } from "../sanity/lib/url-for-image";

// 1) Traemos todos los proyectos
const allProjects: PortfolioProject[] = await getAllPortfolioProjects();

// 2) Tomamos el primer proyecto (si existe) para probar las otras funciones
const sampleProject = allProjects[0];

// 3) Obtenemos un slug de categoría (si existe)
let categorySlug: string | null = null;
if (sampleProject && sampleProject.categories.length > 0) {
  categorySlug = sampleProject.categories[0]?.slug ?? null;
}

// 4) Llamamos a la función de proyectos por categoría (solo si tenemos slug)
let projectsByCategory: PortfolioProject[] = [];
if (categorySlug) {
  projectsByCategory = await getPortfolioProjectsByCategorySlug(categorySlug);
}

// 5) Llamamos a la función por ID (solo si tenemos un proyecto)
let projectById: PortfolioProject | null = null;
if (sampleProject) {
  projectById = await getPortfolioProjectById(sampleProject.id);
}

// Helper para construir URL de imagen
function getProjectImageUrl(project: PortfolioProject) {
  try {
    return urlForImage(project.image.source)
      .width(600)
      .height(360)
      .fit("crop")
      .url();
  } catch {
    return "";
  }
}
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Test Portafolio – Sanity</title>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100">
    <main class="max-w-6xl mx-auto px-4 py-8 space-y-10">
      <header class="space-y-2">
        <h1 class="text-2xl font-bold">Test de Portafolio (Sanity)</h1>
        <p class="text-sm text-slate-400">
          Esta página solo existe para comprobar que las funciones de
          <code class="px-1 py-0.5 rounded bg-slate-900/60"
            >portfolioService</code
          >
          están funcionando correctamente.
        </p>
      </header>

      {/* Sección 1: Todos los proyectos */}
      <section class="space-y-4">
        <h2 class="text-lg font-semibold">
          1. getAllPortfolioProjects() – Proyectos totales ({
            allProjects.length
          })
        </h2>

        {
          allProjects.length === 0 ? (
            <p class="text-sm text-red-400">
              No se encontraron proyectos de portafolio en Sanity. Revisa que
              tengas documentos de tipo
              <code class="px-1 py-0.5 rounded bg-slate-900/60">
                portfolioType
              </code>
              .
            </p>
          ) : (
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
              {allProjects.map((project) => {
                const imgUrl = getProjectImageUrl(project);

                return (
                  <article class="rounded-xl border border-slate-800 bg-slate-900/60 overflow-hidden">
                    {imgUrl && (
                      <img
                        src={imgUrl}
                        alt={project.image.alt}
                        loading="lazy"
                        class="w-full h-40 object-cover"
                      />
                    )}
                    <div class="p-4 space-y-2">
                      <h3 class="font-semibold text-sm">{project.title}</h3>
                      <p class="text-xs text-slate-400 line-clamp-3">
                        {project.description}
                      </p>
                      {project.categories.length > 0 && (
                        <p class="text-[11px] text-slate-500">
                          Categorías:{" "}
                          {project.categories.map((c) => c.title).join(", ")}
                        </p>
                      )}
                    </div>
                  </article>
                );
              })}
            </div>
          )
        }
      </section>

      {/* Sección 2: Proyectos por categoría */}
      <section class="space-y-4">
        <h2 class="text-lg font-semibold">
          2. getPortfolioProjectsByCategorySlug(slug)
        </h2>

        {
          categorySlug ? (
            <>
              <p class="text-sm text-slate-400">
                Usando el slug de la primera categoría encontrada:{" "}
                <code class="px-1 py-0.5 rounded bg-slate-900/60">
                  {categorySlug}
                </code>
                . Proyectos encontrados: {projectsByCategory.length}
              </p>

              {projectsByCategory.length === 0 ? (
                <p class="text-sm text-yellow-400">
                  No se encontraron proyectos para esa categoría, revisa los
                  datos.
                </p>
              ) : (
                <ul class="space-y-2 text-sm text-slate-200">
                  {projectsByCategory.map((p) => (
                    <li class="flex items-center justify-between gap-4 border-b border-slate-800/80 pb-1">
                      <span>{p.title}</span>
                      <span class="text-xs text-slate-500">
                        ({p.categories.map((c) => c.title).join(", ")})
                      </span>
                    </li>
                  ))}
                </ul>
              )}
            </>
          ) : (
            <p class="text-sm text-yellow-400">
              No se pudo obtener ningún slug de categoría porque no hay
              proyectos o los proyectos no tienen categorías.
            </p>
          )
        }
      </section>

      {/* Sección 3: Proyecto por ID */}
      <section class="space-y-4">
        <h2 class="text-lg font-semibold">3. getPortfolioProjectById(id)</h2>

        {
          sampleProject ? (
            <>
              <p class="text-sm text-slate-400">
                Usando el <code>id</code> del primer proyecto encontrado:
                <br />
                <code class="px-1 py-0.5 rounded bg-slate-900/60 text-[11px] break-all">
                  {sampleProject.id}
                </code>
              </p>

              {projectById ? (
                <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4 space-y-2">
                  <h3 class="font-semibold text-sm">{projectById.title}</h3>
                  <p class="text-xs text-slate-400">
                    {projectById.description}
                  </p>
                  {projectById.categories.length > 0 && (
                    <p class="text-[11px] text-slate-500">
                      Categorías:{" "}
                      {projectById.categories.map((c) => c.title).join(", ")}
                    </p>
                  )}
                </div>
              ) : (
                <p class="text-sm text-red-400">
                  La llamada a getPortfolioProjectById devolvió null.
                </p>
              )}
            </>
          ) : (
            <p class="text-sm text-yellow-400">
              No hay proyectos para probar getPortfolioProjectById.
            </p>
          )
        }
      </section>

      {/* Debug JSON */}
      <section class="mt-8 space-y-3">
        <h2 class="text-sm font-semibold text-slate-400">
          Debug: JSON de allProjects
        </h2>
        <pre
          class="text-xs bg-slate-900/80 border border-slate-800 rounded-lg p-3 overflow-x-auto max-h-80">
{JSON.stringify(allProjects, null, 2)}
        </pre>

        <h2 class="text-sm font-semibold text-slate-400">
          Debug: JSON de projectsByCategory
        </h2>
        <pre
          class="text-xs bg-slate-900/80 border border-slate-800 rounded-lg p-3 overflow-x-auto max-h-80">
{JSON.stringify(projectsByCategory, null, 2)}
        </pre>

        <h2 class="text-sm font-semibold text-slate-400">
          Debug: JSON de projectById
        </h2>
        <pre
          class="text-xs bg-slate-900/80 border border-slate-800 rounded-lg p-3 overflow-x-auto max-h-80">
{JSON.stringify(projectById, null, 2)}
        </pre>
      </section>
    </main>
  </body>
</html>
