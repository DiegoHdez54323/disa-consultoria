---
import type { GetStaticPaths } from "astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import CTASection from "../services/CTASection.astro";
import { getAllPortfolioProjects, getPortfolioProjectBySlug } from "@/services/portfolioService";
import { urlForImage } from "@/sanity/lib/url-for-image";

export async function getStaticPaths() {
  const projects = await getAllPortfolioProjects();
  
  // 1. Filtramos los proyectos que NO tengan slug
  const validProjects = projects.filter((project) => project.slug);

  // 2. Mapeamos solo los proyectos válidos
  return validProjects.map((project) => ({
    params: { 
      // Usamos el signo de exclamación (!) para decirle a TS que estamos seguros de que existe
      slug: project.slug! 
    },
  }));
}

const { slug } = Astro.params;
const project = await getPortfolioProjectBySlug(slug as string);

if (!project) {
    return Astro.redirect("/404");
}

const mainImage = project.image?.source
  ? urlForImage(project.image.source).width(1200).height(600).url()
  : "/placeholder.jpg";
---

<BaseLayout
  title={`${project.title} | Portafolio Disa`}
  description={project.description}
>
  <main class="min-h-screen bg-background">
    
    {/* Hero Section del Proyecto */}
    <section class="relative pt-32 pb-16 px-6 md:px-12 max-w-7xl mx-auto">
      <div class="mb-8">
        <h1 class="text-4xl md:text-6xl font-sora font-bold text-foreground mb-4">
          {project.title}
        </h1>
        {project.subtitle && (
          <h2 class="text-xl md:text-2xl text-muted-foreground font-inter max-w-3xl">
            {project.subtitle}
          </h2>
        )}
        
        <div class="flex flex-wrap gap-4 mt-6">
          {project.categories?.map(cat => (
             <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm font-medium">
               {cat.title}
             </span>
          ))}
        </div>
      </div>

      <div class="relative w-full h-[400px] md:h-[600px] rounded-3xl overflow-hidden shadow-2xl">
        <img 
          src={mainImage} 
          alt={project.image.alt}
          class="w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-background/80 to-transparent"></div>
      </div>
    </section>

    {/* Contenido Principal */}
    <section class="px-6 md:px-12 max-w-5xl mx-auto pb-24 space-y-24">
      
      {/* Reto */}
      {project.challenge && (
        <div class="grid md:grid-cols-12 gap-8">
          <div class="md:col-span-3">
            <h3 class="text-2xl font-sora font-bold text-foreground">Reto</h3>
          </div>
          <div class="md:col-span-9">
            <p class="text-lg text-muted-foreground leading-relaxed font-inter">
              {project.challenge}
            </p>
          </div>
        </div>
      )}

      {/* Cita */}
      {project.quote && (
        <div class="bg-muted/30 p-8 md:p-12 rounded-3xl border border-border/50 relative overflow-hidden">
           <div class="relative z-10">
             <p class="text-xl md:text-2xl font-sora font-medium text-foreground italic mb-6">
               "{project.quote.text}"
             </p>
             <cite class="text-primary font-bold not-italic font-inter">
               — {project.quote.author}
             </cite>
           </div>
        </div>
      )}

      {/* Qué Logramos */}
      {project.results && project.results.length > 0 && (
        <div class="grid md:grid-cols-12 gap-8">
          <div class="md:col-span-12 mb-4">
            <h3 class="text-3xl font-sora font-bold text-foreground">¿Qué logramos?</h3>
          </div>
          <div class="md:col-span-12 grid md:grid-cols-2 gap-8">
            {project.results.map((result, index) => (
              <div class="bg-card p-6 rounded-2xl border border-border/50 hover:border-primary/50 transition-colors">
                <span class="text-5xl font-bold text-primary/20 mb-4 block">0{index + 1}</span>
                <h4 class="text-xl font-bold text-foreground mb-2 font-sora">{result.title}</h4>
                <p class="text-muted-foreground font-inter">{result.description}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Cómo lo hicimos */}
      {project.process && project.process.length > 0 && (
        <div>
          <h3 class="text-3xl font-sora font-bold text-foreground mb-12">¿Cómo lo hicimos?</h3>
          <div class="relative border-l-2 border-primary/20 ml-4 md:ml-0 space-y-12">
            {project.process.map((step, index) => (
              <div class="relative pl-8 md:pl-12">
                <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-primary ring-4 ring-background"></div>
                <h4 class="text-xl font-bold text-foreground mb-2 font-sora">{step.title}</h4>
                <p class="text-muted-foreground font-inter max-w-2xl">{step.description}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Footer del Proyecto: Tags e Industrias */}
      <div class="border-t border-border pt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <h4 class="text-sm font-bold text-foreground uppercase tracking-wider mb-4">Tecnologías / Tags</h4>
          <div class="flex flex-wrap gap-2">
            {project.technologies.map(tech => (
              <span class="px-3 py-1 bg-muted text-muted-foreground rounded-md text-sm">
                {tech}
              </span>
            ))}
          </div>
        </div>
        
        {project.industries && (
          <div>
            <h4 class="text-sm font-bold text-foreground uppercase tracking-wider mb-4">Industrias</h4>
            <div class="flex flex-wrap gap-2">
              {project.industries.map(ind => (
                <span class="px-3 py-1 bg-muted text-muted-foreground rounded-md text-sm">
                  {ind}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>

    </section>

    <CTASection />
  </main>
</BaseLayout>