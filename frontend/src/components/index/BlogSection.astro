---
import { ArrowRight, Clock, User } from "lucide-astro";
import type { BlogPost } from "../../sanity/types/blog";
import { urlForImage } from "../../sanity/lib/url-for-image";

interface Props {
  posts: BlogPost[];
}

const { posts } = Astro.props;

function getPostImageUrl(post: BlogPost) {
  if (!post.mainImage?.source) return "";
  try {
    return urlForImage(post.mainImage.source)
      .width(800)
      .height(450)
      .fit("crop")
      .format("webp")
      .url();
  } catch {
    return "";
  }
}

function formatDate(dateString: string) {
  const d = new Date(dateString);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleDateString("es-MX", {
    day: "2-digit",
    month: "short",
    year: "numeric",
  });
}
---

<section
  class="relative py-24 bg-background overflow-hidden section-fade-bottom section-fade-top"
  id="blog-section"
>
  <div class="absolute inset-0 bg-grid opacity-20 pointer-events-none"></div>
  <div
    class="absolute top-1/2 left-0 w-[500px] h-[500px] bg-primary/5 rounded-full blur-3xl -translate-y-1/2 pointer-events-none"
  >
  </div>

  <div class="relative container mx-auto px-6">
    {/* Header */}
    <div
      class="flex flex-col md:flex-row md:items-end md:justify-between mb-16 opacity-0 translate-y-8 transition-all duration-700 ease-out scroll-reveal"
    >
      <div>
        <span
          class="inline-block px-4 py-1 rounded-full bg-accent/10 text-accent text-sm font-inter font-medium mb-4"
        >
          Blog
        </span>
        <h2
          class="font-orbitron text-3xl md:text-5xl font-bold text-foreground mb-4"
        >
          Ideas que
          <span
            class="text-gradient-primary bg-clip-text text-transparent bg-linear-to-r from-primary to-accent"
            >impulsan</span
          >
        </h2>
        <p class="font-inter text-lg text-muted-foreground max-w-xl">
          Artículos, guías y reflexiones sobre tecnología, desarrollo y el
          futuro digital.
        </p>
      </div>

      <a
        href="/blog"
        class="mt-6 md:mt-0 inline-flex items-center gap-2 text-primary font-inter font-medium hover:gap-3 transition-all group"
      >
        Ver todos los artículos
        <ArrowRight
          class="w-4 h-4 transition-transform group-hover:translate-x-1"
        />
      </a>
    </div>

    {/* Grid de Posts */}
    {
      posts.length === 0 ? (
        <p class="text-sm text-muted-foreground">
          Aún no hay artículos publicados.
        </p>
      ) : (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {posts.map((post, index) => {
            const imgUrl = getPostImageUrl(post);
            const category =
              post.categories && post.categories.length > 0
                ? post.categories[0].title
                : "Sin categoría";
            const dateLabel = formatDate(post.publishedAt);
            const readTimeLabel = post.readTime ? `${post.readTime} min` : "";

            return (
              <article
                class="group relative opacity-0 translate-y-8 transition-all duration-500 ease-out scroll-reveal"
                style={`transition-delay: ${index * 150}ms`}
              >
                <a href={`/blog/${post.slug}`} class="block h-full">
                  <div class="relative h-full rounded-2xl overflow-hidden border border-border/50 bg-card transition-all duration-500 hover:border-primary/30 hover:glow-primary">
                    {/* Contenedor de Imagen */}
                    <div class="relative h-52 overflow-hidden bg-muted">
                      {imgUrl && (
                        <img
                          src={imgUrl}
                          alt={post.mainImage?.alt || post.title}
                          class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                          loading="lazy"
                        />
                      )}
                      <div class="absolute inset-0 bg-linear-to-t from-card via-transparent to-transparent" />

                      <div class="absolute top-4 left-4 px-3 py-1 rounded-full bg-primary/20 text-primary text-xs font-inter font-medium backdrop-blur-sm">
                        {category}
                      </div>
                    </div>

                    {/* Contenido Texto */}
                    <div class="p-6">
                      <h3 class="font-orbitron text-lg font-semibold text-foreground mb-3 line-clamp-2 group-hover:text-primary transition-colors">
                        {post.title}
                      </h3>
                      <p class="font-inter text-sm text-muted-foreground mb-4 line-clamp-2">
                        {post.excerpt}
                      </p>

                      <div class="flex items-center justify-between text-xs text-muted-foreground">
                        <div class="flex items-center gap-2">
                          <User class="w-3 h-3" />
                          <span>{post.author.name}</span>
                        </div>
                        <div class="flex items-center gap-4">
                          <span>{dateLabel}</span>
                          {readTimeLabel && (
                            <div class="flex items-center gap-1">
                              <Clock class="w-3 h-3" />
                              <span>{readTimeLabel}</span>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </article>
            );
          })}
        </div>
      )
    }
  </div>
</section>

<script>
  function initScrollReveal() {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.remove("opacity-0", "translate-y-8");
            entry.target.classList.add("opacity-100", "translate-y-0");
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.1 }
    );

    document
      .querySelectorAll(".scroll-reveal")
      .forEach((el) => observer.observe(el));
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initScrollReveal);
  } else {
    initScrollReveal();
  }
</script>
